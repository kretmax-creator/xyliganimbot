# План разработки xyliganimbot MVP

## Общая информация

- **Срок разработки**: 2-3 недели (10-15 рабочих дней)
- **Длительность итерации**: 1 день
- **Принципы**: KISS, MVP-first, файловое хранилище, без БД
- **Цель**: Поиск ответов в базе знаний через Telegram-бота

---

## Итерации разработки

### Итерация 1: Настройка проекта и окружения
**День 1**

**Цель**: Создать базовую структуру проекта и настроить окружение разработки.

**Задачи**:
- [x] Создать структуру папок согласно [vision.md](vision.md)
- [x] Настроить Python окружение (venv, requirements.txt)
- [x] Создать базовые файлы: `README.md`, `.env.example`, `.gitignore`
- [x] Настроить форматирование кода (black, базовые настройки)
- [x] Создать `config.yaml.example` с примером конфигурации
- [x] Настроить базовое логирование (модуль `src/logging.py`)

**Результат**: Готовая структура проекта, настроенное окружение, можно начинать разработку.

---

### Итерация 2: Базовая интеграция с Telegram
**День 2**

**Цель**: Реализовать базовое подключение к Telegram Bot API и обработку сообщений.

**Задачи**:
- [x] Установить библиотеку `python-telegram-bot` (или `aiogram`)
- [x] Создать модуль `src/bot.py` с базовой инициализацией бота
- [x] Реализовать long polling для получения обновлений
- [x] Создать базовый обработчик сообщений (пока только логирование)
- [x] Реализовать проверку белого списка пользователей/чатов
- [x] Добавить обработку ошибок подключения к Telegram API

**Результат**: Бот подключается к Telegram, получает сообщения, проверяет белый список.

---

### Итерация 3: Модуль работы с конфигурацией
**День 3**

**Цель**: Реализовать загрузку и валидацию конфигурации.

**Задачи**:
- [x] Создать модуль `src/config.py` для работы с конфигурацией
- [x] Реализовать загрузку `config.yaml`
- [x] Реализовать загрузку переменных окружения (секреты)
- [x] Добавить валидацию обязательных параметров
- [x] Реализовать загрузку белых списков (пользователи, чаты, админы)
- [x] Добавить обработку ошибок конфигурации

**Результат**: Конфигурация загружается и валидируется при старте бота.

---

### Итерация 4: Импорт документа из Google Docs (базовая версия)
**День 4**

**Цель**: Реализовать базовый импорт документа из Google Docs в Markdown.

**Задачи**:
- [x] Создать модуль `src/google_docs.py`
- [x] Реализовать получение ZIP-архива с HTML и изображениями (HTTP-запрос к export?format=zip)
- [x] Реализовать распаковку ZIP-архива
- [x] Извлечение HTML-файла из архива
- [x] Извлечение изображений из архива в папку `data/images/`
- [x] Сохранение HTML в `data/knowledge.html` (или конвертация в Markdown)
- [x] Обновление ссылок на изображения в HTML/Markdown (на локальные пути)
- [x] Добавить обработку ошибок доступа к документу и распаковки архива
- [x] Логирование операций импорта

**Результат**: Бот может импортировать документ из Google Docs в виде ZIP-архива, извлекать HTML и изображения. Изображения сохраняются локально для отправки пользователям.

---

### Итерация 5: Обработка изображений и улучшение импорта
**День 5**

**Цель**: Добавить извлечение изображений и улучшить парсинг документа.

**Задачи**:
- [ ] Создать JSON-файл `data/sections.json` для хранения заголовков разделов
- [ ] Добавить пример структуры файла с заголовками (массив строк)
- [ ] Создать JSON-кэш с метаданными (`data/knowledge_cache.json`)
- [ ] Добавить поля: `content`, `last_updated`, `document_id`, `images` (список путей к локальным файлам)
- [ ] Реализовать проверку даты обновления документа
- [ ] Сохранять пути к локальным изображениям в кэше
- [ ] Создать структуру для связи изображений с разделами документа (опционально)

**Результат**: Создана структура для хранения метаданных документа и заголовков разделов. Заголовки разделов управляются вручную через JSON-файл. Изображения хранятся локально.

---

### Итерация 6: Поисковая система - обратный индекс
**День 6**

**Цель**: Реализовать построение обратного индекса для быстрого поиска.

**Задачи**:
- [ ] Создать модуль `src/search.py`
- [ ] Реализовать загрузку заголовков разделов из `data/sections.json`
- [ ] Реализовать разбиение документа на разделы (по заголовкам из JSON-файла)
- [ ] Реализовать построение двухуровневого обратного индекса:
  - Индекс разделов: ключевые слова → разделы (для быстрого определения релевантных разделов)
  - Индекс содержимого: ключевые слова → позиции в тексте разделов (для точного поиска и ранжирования)
- [ ] Сохранять индекс в JSON-кэш
- [ ] Реализовать обновление индекса при импорте документа
- [ ] Добавить базовую нормализацию текста (приведение к нижнему регистру, удаление знаков препинания)
- [ ] Добавить обработку ошибок при отсутствии файла с заголовками

**Результат**: Двухуровневый обратный индекс строится при импорте документа. Разделение на разделы происходит по заголовкам из JSON-файла, управляемого вручную. Индексация включает как разделы, так и содержимое разделов.

---

### Итерация 7: Поисковая система - поиск и ранжирование
**День 7**

**Цель**: Реализовать поиск по индексу и ранжирование результатов.

**Задачи**:
- [ ] Реализовать функцию поиска по обратному индексу
- [ ] Реализовать ранжирование результатов по количеству совпадений
- [ ] Ограничить количество результатов (5 наиболее релевантных)
- [ ] Реализовать извлечение текста найденных разделов
- [ ] Добавить обработку случая "ничего не найдено"
- [ ] Логирование результатов поиска

**Результат**: Поиск работает, возвращает ранжированные результаты.

---

### Итерация 8: Обработка команд и сообщений пользователей
**День 8**

**Цель**: Реализовать обработку команд и текстовых запросов пользователей.

**Задачи**:
- [ ] Создать модуль `src/handlers/` с обработчиками
- [ ] Реализовать обработчик команды `/help`
- [ ] Реализовать обработку всех сообщений как запросов к базе знаний
- [ ] Интегрировать поисковую систему с обработчиками
- [ ] Реализовать отправку ответов в чат (reply на сообщение)
- [ ] Добавить отправку изображений из папки `data/images/` как файлов (photo) в Telegram-чате вместе с текстом или отдельными сообщениями

**Результат**: Бот отвечает на команды и текстовые запросы пользователей.

---

### Итерация 9: Админские команды и обновление кэша
**День 9**

**Цель**: Реализовать админские команды для управления ботом.

**Задачи**:
- [ ] Реализовать проверку прав администратора
- [ ] Реализовать команду `/admin refresh_cache` для принудительного обновления
- [ ] Добавить периодическое обновление кэша (раз в неделю, фоновый процесс)
- [ ] Реализовать обработку ошибок при обновлении
- [ ] Добавить уведомления администратору о статусе обновления
- [ ] Логирование админских операций

**Результат**: Администраторы могут управлять обновлением базы знаний.

---

### Итерация 10: Логирование и аудит
**День 10**

**Цель**: Реализовать полноценное логирование и журнал действий.

**Задачи**:
- [ ] Расширить модуль логирования (`src/logging.py`)
- [ ] Реализовать ротацию логов по размеру файла
- [ ] Создать модуль аудита (`src/audit.py`)
- [ ] Реализовать запись в `logs/audit.log` для каждой операции
- [ ] Добавить настройку логирования текстов сообщений (по умолчанию отключено)
- [ ] Реализовать логирование всех уровней (DEBUG, INFO, WARNING, ERROR)

**Результат**: Полноценное логирование и аудит всех операций.

---

### Итерация 11: Обработка ошибок и устойчивость
**День 11**

**Цель**: Улучшить обработку ошибок и устойчивость бота.

**Задачи**:
- [ ] Реализовать централизованную обработку ошибок
- [ ] Добавить обработку всех типов ошибок (файлы, сеть, данные)
- [ ] Реализовать понятные сообщения пользователю при ошибках
- [ ] Добавить fallback на кэш при недоступности Google Docs
- [ ] Улучшить обработку сетевых ошибок Telegram API
- [ ] Добавить retry для критичных операций (опционально)

**Результат**: Бот устойчив к ошибкам, пользователи получают понятные сообщения.

---

### Итерация 12: Docker и контейнеризация
**День 12**

**Цель**: Создать Docker-образ для развертывания.

**Задачи**:
- [ ] Создать `Dockerfile` для сборки образа
- [ ] Настроить multi-stage build (опционально)
- [ ] Создать `.dockerignore`
- [ ] Настроить переменные окружения в контейнере
- [ ] Протестировать сборку и запуск контейнера локально
- [ ] Обновить `README.md` с инструкциями по Docker

**Результат**: Готовый Docker-образ, можно запускать в контейнере.

---

### Итерация 13: Kubernetes манифесты
**День 13**

**Цель**: Создать манифесты для развертывания в Kubernetes.

**Задачи**:
- [ ] Создать `k8s/namespace.yaml`
- [ ] Создать `k8s/deployment.yaml`
- [ ] Создать `k8s/service.yaml` (если требуется)
- [ ] Создать `k8s/configmap.yaml` для конфигурации
- [ ] Создать `k8s/secret.yaml.template` для секретов
- [ ] Создать `k8s/persistent-volume.yaml` и `k8s/persistent-volume-claim.yaml` для логов и кэша
- [ ] Добавить инструкции по развертыванию в `README.md`

**Результат**: Готовые манифесты для развертывания в Kubernetes.

---

### Итерация 14: Тестирование и отладка
**День 14**

**Цель**: Протестировать все функции бота и исправить найденные проблемы.

**Задачи**:
- [ ] Ручное тестирование всех команд
- [ ] Тестирование поиска с различными запросами
- [ ] Тестирование импорта документа
- [ ] Тестирование обработки ошибок
- [ ] Тестирование белых списков
- [ ] Тестирование админских команд
- [ ] Исправление найденных багов
- [ ] Проверка логирования и аудита

**Результат**: Протестированный и отлаженный бот.

---

### Итерация 15: Документация и финализация
**День 15**

**Цель**: Завершить документацию и подготовить к релизу.

**Задачи**:
- [ ] Обновить `README.md` с полными инструкциями
- [ ] Создать документацию по командам бота
- [ ] Добавить примеры конфигурации
- [ ] Создать инструкции по развертыванию через SSH
- [ ] Проверить все ссылки и примеры в документации
- [ ] Создать `CHANGELOG.md` или release notes
- [ ] Финальная проверка кода и документации

**Результат**: Полная документация, готовый к релизу MVP.
