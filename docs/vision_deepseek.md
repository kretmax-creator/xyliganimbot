# Xyliganimbot - Техническое видение проекта

## 1. Общее видение
Xyliganimbot - минималистичный Telegram-бот для корпоративного группового чата, предоставляющий быстрый доступ к базе знаний через естественноязыковые запросы. Бот следует принципам KISS (Keep It Simple, Stupid) и YAGNI (You Aren't Gonna Need It), фокусируясь на решении конкретных задач без избыточной сложности.

## 2. Ключевые принципы
- **Минимализм**: Только необходимый функционал для MVP
- **Простота**: Понятные решения вместо сложных архитектур
- **Практичность**: Работающий прототип важнее идеальной архитектуры
- **Инкрементальность**: Постепенное развитие от простого к сложному

## 3. Технологический стек
### Базовые технологии
- **Язык**: Python 3.11+ (баланс производительности и простоты)
- **Фреймворк**: python-telegram-bot 20.x (асинхронный, официальный)
- **Google API**: Google Docs API через Service Account
- **Хранение**: Локальные файлы (JSON кэш, конфигурация)

### Отказ от сложных решений
- **Без баз данных**: Используем Google Docs как источник истины
- **Без LLM**: Простой текстовый поиск вместо нейросетей
- **Без микросервисов**: Монолитная архитектура для MVP
- **Без ORM**: Прямая работа с файлами и API

## 4. Архитектурные решения
### Компонентная структура
1. **Ядро бота** - обработка Telegram-сообщений и команд
2. **Интеграция с Google Docs** - загрузка и парсинг документа
3. **Поисковый движок** - простой текстовый поиск по кэшу
4. **Система кэширования** - локальное хранение данных документа
5. **Конфигурация** - управление настройками через файлы

### Поток данных
Пользователь → Telegram Bot → Поиск в кэше → Ответ пользователю
Кэш периодически синхронизируется с Google Docs

### Состояние системы
Бот практически stateless - вся необходимая информация хранится в:
- Конфигурационных файлах (.env, config.yaml)
- Локальном кэше документа
- Временных файлах изображений

## 5. Модель данных
### Источник данных
- Единственный Google Document как база знаний
- Структура: заголовки (категории) → текст → изображения
- Прямая ссылка на документ через Service Account

### Локальное представление
- Кэш в формате JSON с разбивкой по секциям
- Каждая секция содержит: заголовок, текст, ссылки на изображения
- Обратный индекс для быстрого поиска по ключевым словам

### Обработка изображений
- Изображения хранятся как ссылки на оригиналы в Google
- При необходимости - загрузка превью определенного размера
- Отправка изображений отдельными сообщениями после текста

## 6. Функциональные возможности
### Для всех пользователей
- Естественноязыковой поиск по базе знаний
- Получение текстовых ответов с изображениями
- Базовые команды: /start, /help, /search

### Для администраторов
- Принудительная синхронизация документа (/sync)
- Просмотр статистики (/stats)
- Управление через конфигурационные файлы

### Системные функции
- Автоматическая синхронизация раз в день
- Проверка белых списков чатов и пользователей
- Логирование ключевых событий

## 7. Поисковая система
### Упрощенный подход
- Линейный поиск по ключевым словам
- Учет совпадений в заголовках и тексте
- Ранжирование по количеству совпадений
- Ограничение результатов (5 наиболее релевантных)

### Возможные улучшения (post-MVP)
- Поддержка синонимов
- Стемминг для русского языка
- Нечеткий поиск (fuzzy matching)
- Локальные эмбеддинги при необходимости

## 8. Интеграция с Google Docs
### Основные возможности
- Чтение документа через Service Account (без OAuth пользователей)
- Парсинг структуры: заголовки, текст, изображения
- Извлечение ссылок на встроенные изображения
- Обработка форматирования текста (базовая)

### Синхронизация
- Фоновое обновление раз в сутки
- Ручная синхронизация по команде администратора
- Использование кэша при недоступности Google Docs

## 9. Сценарии использования
### Основной сценарий
Пользователь задает вопрос в чате → бот находит релевантную секцию → отправляет текст и прикрепленные изображения

### Административные сценарии
1. Обновление базы знаний: правка Google Doc → команда /sync
2. Настройка доступа: редактирование config.yaml → перезапуск бота
3. Мониторинг: просмотр логов и статистики

### Обработка ошибок
- При недоступности Google Docs используется актуальный кэш
- Пользователи вне белых списков игнорируются
- Ошибки логируются без раскрытия деталей пользователям

## 10. Деплой и инфраструктура
### Целевые платформы
1. **Docker** - основной способ развертывания
2. **Kubernetes** - для масштабируемых инсталляций
3. **Любой VPS** с поддержкой Docker

### Требования к инфраструктуре
- Минимальные ресурсы: 1 CPU, 512MB RAM, 1GB disk
- Доступ в интернет (Telegram API, Google Docs API)
- Постоянное хранилище для кэша и логов

### Контейнеризация
- Один контейнер со всеми зависимостями
- Тома для кэша и логов
- Переменные окружения для конфигурации

## 11. Конфигурационная модель
### Разделение конфигурации
- **Секреты**: токены и ключи в .env файле
- **Настройки**: параметры приложения в config.yaml
- **Константы**: значения по умолчанию в коде

### Основные параметры
- Белые списки чатов и пользователей
- Идентификаторы Google документа
- Параметры поиска и синхронизации
- Настройки логирования

### Управление конфигурацией
- Изменения требуют перезапуска приложения
- Конфигурационные файлы хранятся в репозитории (кроме .env)
- Простая валидация обязательных параметров

## 12. Стратегия логгирования
### Уровни логирования
- ERROR: Критические сбои системы
- WARNING: Некритические проблемы
- INFO: Ключевые события (по умолчанию)
- DEBUG: Детальная отладка (только при разработке)

### Структура логов
- JSON формат для машинной обработки
- Обязательные поля: timestamp, level, message
- Контекстные поля: user_id, chat_id, query и др.
- Исключение чувствительных данных

### Управление логами
- Ротация по размеру файла
- Отдельные лог-файлы для разных компонентов
- Логирование в stdout для контейнерных окружений

## 13. Безопасность
### Меры защиты
- Белые списки чатов и пользователей
- Service Account вместо пользовательских OAuth токенов
- Отсутствие хранения чувствительных данных
- Логирование без приватной информации

### Доступ к функциям
- Публичные команды: /start, /help, поиск
- Административные команды: проверка прав доступа
- Конфигурация: только через файлы при перезапуске

## 14. Дорожная карта развития
### Фаза 1: MVP (2-3 недели)
- Базовый бот с простым поиском
- Интеграция с Google Docs (текст)
- Система белых списков
- Docker-контейнеризация

### Фаза 2: Расширение (2-3 недели)
- Поддержка изображений
- Улучшенный поиск
- Административные команды
- Продвинутое логирование

### Фаза 3: Оптимизация (1-2 недели)
- Производительность поиска
- Улучшение обработки ошибок
- Документация и примеры

### Будущие возможности
- Поддержка нескольких документов
- Веб-интерфейс для администрирования
- Интеграция с другими системами
- Расширенная аналитика использования

## 15. Ограничения и компромиссы
### Принятые упрощения
- Поиск только по одному документу
- Отсутствие реального NLP/LLM
- Конфигурация только через перезапуск
- Базовая обработка изображений

### Потенциальные проблемы
- Производительность при больших документах
- Ограничения Google Docs API
- Отсутствие интерактивности в ответах
- Простота поиска может давать неточные результаты

### Стратегия улучшений
Каждое улучшение должно обосновываться конкретными потребностями пользователей и измеряемыми метриками. Приоритет - стабильность и простота.