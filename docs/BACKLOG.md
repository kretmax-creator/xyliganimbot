# Бэклог проекта xyliganimbot

## Высокий приоритет (MVP)

### 1. Настройка проекта
- Структура папок
- Python окружение
- Базовые файлы конфигурации

### 2. Telegram интеграция
- Подключение к Bot API
- Long polling
- Проверка белого списка

### 3. Конфигурация
- Загрузка config.yaml
- Переменные окружения
- Валидация

### 4. Загрузка контента базы знаний
- Получение документа из Google Docs (HTML-экспорт в ZIP-архиве)
- Распаковка ZIP-архива
- Извлечение изображений из архива
- Сохранение документа в файл `data/knowledge.md`
- Сохранение изображений в папку `data/images/`
- Сохранение метаданных в кэш
- Импорт выполняется отдельным скриптом вне Telegram-бота (не командой бота)
- Архитектура: независимый модуль, позволяющий добавлять другие источники контента

### 5. Загрузка embedding-модели
- Загрузка модели из HuggingFace
- Сохранение модели в папку `models/`
- Проверка наличия модели при работе
- Архитектура: независимый процесс, не связанный с загрузкой контента

### 6. Векторизация контента
- Разделение документа на разделы по заголовкам (извлекаются автоматически из Markdown)
- Загрузка embedding-модели из `models/`
- Векторизация разделов через embedding-модель
- Сохранение векторов в кэш `data/knowledge_cache.json`
- Сохранение связи изображений с разделами
- Архитектура: независимый процесс, работает с локальными файлами (`data/knowledge.md`), не зависит от источника контента

### 7. Поисковая система (семантический поиск)
- Семантический поиск через косинусное сходство
- Ранжирование результатов по score
- Возврат цитат (snippet или полный текст раздела)
- Ограничение результатов (топ-N)

### 8. Обработка команд
- /help
- Текстовые запросы
- Админские команды (load_model, vectorize); импорт контента — отдельным скриптом вне бота

### 9. Логирование и аудит
- Файловое логирование
- Ротация логов
- Журнал действий

### 10. Docker и Kubernetes
- Dockerfile
- K8s манифесты
- Инструкции по деплою

---

## Средний приоритет (улучшения)

### 11. Обработка изображений
- Извлечение ссылок
- Отправка в ответах

### 12. Улучшения админских команд
- Команда для загрузки embedding-модели
- Проверки состояния данных при работе

### 13. Улучшение поиска
- Подсветка конкретного релевантного места в разделе
- Анализ подобия фраз для более точного выделения фрагментов

---

## Низкий приоритет (будущее)

### 14. LLM интеграция
**Статус**: Не в MVP

### 15. Статистика использования
**Статус**: Не в MVP

### 16. История запросов
**Статус**: Не в MVP

### 17. Веб-интерфейс
**Статус**: Не в MVP

---

## Рекомендации по улучшению (из результатов тестирования)

**Источник:** Результаты ручного тестирования (23.01.2026) - см. `docs/TEST_REPORT.md`

### Высокий приоритет

1. **Заменить embedding-модель** на `intfloat/multilingual-e5-small` для улучшения качества поиска
   - **Файлы:** `src/search.py`, `src/bot.py`, `src/model_loader.py`
   - **Изменение:** Заменить `paraphrase-multilingual-MiniLM-L12-v2` на `intfloat/multilingual-e5-small` во всех местах
   - **Важно:** Требует пересоздания embeddings кэша (выполнить `/admin vectorize` после замены модели)
   - **Примечание:** Модель E5 требует специального формата запросов (добавить префикс "query: " для запросов)

2. **Повысить порог min_score** с 0.2 до 0.25-0.3 для фильтрации нерелевантных результатов
   - **Файл:** `src/search.py`, функция `search()` и `semantic_search()`
   - **Изменение:** Параметр `min_score` в вызовах функций

3. **Улучшить обработку ошибок** при отсутствии модели и embeddings
   - **Файл:** `src/handlers/messages.py`, функция `handle_search_query()`
   - **Изменение:** Улучшить проверки и сообщения об ошибках

4. **Добавить предварительную фильтрацию** для запросов только с символами
   - **Файл:** `src/search.py`, функция `preprocess_query()` или `search()`
   - **Изменение:** Проверка на запросы только с символами перед поиском

### Средний приоритет

4. **Расширить словарь нормализации:**
   - "удаленка" → "vrm"
   - "учетка" → "учетная запись"
   - "pin" → "1234567890" (или улучшить текст раздела)
   - **Файл:** `src/search.py`, словарь `QUERY_REPLACEMENTS`

5. **Добавить обработку опечаток** через библиотеку `pyspellchecker` или расширить словарь
   - **Файл:** `src/search.py`, функция `preprocess_query()`
   - **Зависимости:** Добавить `pyspellchecker` в `requirements.txt`

6. **Улучшить текст разделов** - добавить явные упоминания ключевых терминов (например, "заводской PIN" в разделе про токен)
   - **Файл:** `data/knowledge.md` (внешний источник контента)
   - **Примечание:** Требует изменения исходного документа

### Низкий приоритет

7. **Рассмотреть использование более мощной модели** для улучшения понимания контекста (после замены на E5)
   - **Варианты:** `sentence-transformers/paraphrase-multilingual-mpnet-base-v2` или специализированные модели для русского языка
   - **Файл:** `src/search.py`, функция `load_embedding_model()`
   - **Примечание:** Требует пересоздания embeddings кэша

8. **Добавить автоматизированные тесты** для проверки форматирования и разбиения сообщений
   - **Файл:** Создать `test_formatting.py` или расширить существующие тесты
   - **Покрытие:** TC-2.1.2, TC-2.1.3, TC-2.1.4, TC-2.3.1, TC-2.3.2

9. **Улучшить ранжирование** для точных фактов (адреса, пароли, телефоны)
   - **Файл:** `src/search.py`, функция `semantic_search()`
   - **Изменение:** Добавить boost для разделов, содержащих URL/адреса/телефоны при соответствующих запросах
