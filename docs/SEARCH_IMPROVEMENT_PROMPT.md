# Промпт для доработки поисковой системы xyliganimbot

## Контекст проекта

Ты работаешь над улучшением поисковой системы для проекта **xyliganimbot** — Telegram-бота для поиска ответов в базе знаний (документ Google Docs).

**Цель задачи**: Доработать алгоритм поиска, токенизацию и создание индекса базы знаний для улучшения качества результатов поиска.

## Важные документы

Обязательно изучи перед началом работы:

1. **`docs/vision.md`** — техническое видение проекта (архитектура, модель данных)
2. **`docs/conventions.md`** — правила и конвенции разработки (КРИТИЧЕСКИ ВАЖНО!)
3. **`docs/tasklist_v0.1.md`** — план разработки (итерации 6 и 7)
4. **`docs/idea.md`** — описание идеи проекта и требования

## Текущее состояние

### Что уже реализовано

- **Итерация 1-5**: Базовая структура проекта, интеграция с Telegram, импорт документа из Google Docs
- **Итерация 8**: Обработка команд и сообщений пользователей (частично — без изображений)

### Что нужно доработать

**Итерации 6 и 7** нужно выполнить заново с улучшениями:

- **Итерация 6**: Поисковая система - обратный индекс
- **Итерация 7**: Поисковая система - поиск и ранжирование

## Проблемы текущей реализации

Текущий алгоритм поиска работает, но качество результатов требует улучшения:

1. **Токенизация**: Текущая реализация слишком простая, не учитывает морфологию русского языка
2. **Индексация**: Индекс может быть неоптимальным для поиска
3. **Ранжирование**: Формула ранжирования может быть улучшена
4. **Поиск**: Алгоритм поиска может быть более точным

## Исходные данные

Для работы доступны следующие файлы:

- **`data/knowledge.html`** — HTML-документ базы знаний
- **`data/sections.json`** — файл с заголовками разделов (23 заголовка, управляются вручную)
- **`data/knowledge_cache.json`** — текущий кэш с индексом (можно использовать как референс)
- **`src/search.py`** — текущая реализация поисковой системы

## Задачи

### Итерация 6: Поисковая система - обратный индекс (переделать)

**Цель**: Реализовать улучшенное построение обратного индекса для быстрого и точного поиска.

**Задачи**:
- [ ] Изучить текущую реализацию в `src/search.py`
- [ ] Улучшить токенизацию текста:
  - Учитывать морфологию русского языка (опционально, можно использовать библиотеки типа `pymorphy2`)
  - Обрабатывать стоп-слова (удалять незначимые слова)
  - Нормализация слов (приведение к базовой форме)
- [ ] Улучшить построение индекса:
  - Двухуровневый индекс (разделы + содержимое) — уже реализовано, но можно улучшить
  - Учет частоты вхождений токенов
  - Взвешивание токенов (TF-IDF или упрощенная версия)
- [ ] Сохранение индекса в `data/knowledge_cache.json`
- [ ] Обновление индекса при импорте документа

**Результат**: Улучшенный обратный индекс, который обеспечивает более точный поиск.

### Итерация 7: Поисковая система - поиск и ранжирование (переделать)

**Цель**: Реализовать улучшенный поиск и ранжирование результатов.

**Задачи**:
- [ ] Изучить текущую реализацию функции `search()` в `src/search.py`
- [ ] Улучшить алгоритм поиска:
  - Учет частичных совпадений
  - Поиск по фразам (не только по отдельным словам)
  - Учет порядка слов в запросе
- [ ] Улучшить ранжирование результатов:
  - Более точная формула релевантности
  - Учет позиции совпадений в тексте
  - Учет частоты вхождений
  - Взвешивание по важности разделов
- [ ] Ограничение количества результатов (5 наиболее релевантных)
- [ ] Извлечение текста найденных разделов (`get_section_text()`)
- [ ] Обработка случая "ничего не найдено"
- [ ] Логирование результатов поиска

**Результат**: Улучшенный поиск с более точным ранжированием результатов.

## Принципы разработки

**КРИТИЧЕСКИ ВАЖНО** — следуй принципам KISS (Keep It Simple, Stupid):

- **KISS** — максимально простое решение без лишних абстракций
- **MVP-first** — реализуется только необходимый минимум
- **Файловое хранилище** — без БД, все данные в файлах (HTML, JSON)
- **Python only** — весь код на Python (>= 3.10)
- **Минимализм** — маленькие, понятные инкременты
- **Стандартный logging** — используй только стандартный `logging`

## Структура проекта

```
xyliganimbot/
├── src/
│   ├── search.py          # Модуль поисковой системы (основной файл для работы)
│   └── ...
├── data/
│   ├── knowledge.html     # HTML-документ базы знаний
│   ├── sections.json      # Заголовки разделов (23 заголовка)
│   └── knowledge_cache.json  # Кэш с индексом
└── docs/
    ├── vision.md          # Техническое видение
    ├── conventions.md     # Правила разработки
    └── tasklist_v0.1.md  # План разработки
```

## Технологии

- **Python 3.10+** с минимальными зависимостями
- **Стандартные библиотеки**: `html.parser`, `json`, `pathlib`, `logging`, `re`
- **Опционально**: `pymorphy2` для морфологического анализа (если решишь использовать)

## Процесс работы

**Строго следуй `docs/conventions.md` и `docs/workflow.md`:**

1. **Пошаговый процесс** — любая задача выполняется по шагам, переход к следующему шагу только после подтверждения пользователя
2. **Планирование перед реализацией** — перед написанием кода опиши решение на высоком уровне, перечисли затрагиваемые файлы, запроси подтверждение
3. **Работа по итерациям** — работай строго по плану из `docs/tasklist_v0.1.md`, последовательно, итерация за итерацией
4. **Обновление прогресса** — после завершения итерации обновляй таблицу прогресса в `docs/tasklist_v0.1.md`
5. **Коммиты** — делай коммиты после подтверждения завершения итерации

## Работа с веткой

**ВАЖНО**: Все изменения должны коммититься в ветку `search-improvement`:

```bash
git checkout search-improvement
# ... работа ...
git add ...
git commit -m "Итерация 6: улучшенная токенизация и индексация"
git push origin search-improvement
```

## Ограничения

**НЕ изменяй следующие части проекта:**
- Обработчики команд и сообщений (`src/handlers/`)
- Основной модуль бота (`src/bot.py`)
- Модуль импорта документа (`src/google_docs.py`)
- Конфигурацию и логирование

**Работай только с:**
- `src/search.py` — модуль поисковой системы
- `data/knowledge_cache.json` — структура кэша (можно изменить формат индекса)
- Тестовые скрипты для проверки поиска (можно создавать новые)

## Критерии готовности

Задача считается выполненной, если:
- Код написан и работает
- Соответствует принципам KISS
- Соответствует правилам из `docs/conventions.md`
- Логирование работает
- Ошибки обрабатываются
- Задача отмечена в `docs/tasklist_v0.1.md`
- Получено подтверждение от пользователя
- Изменения закоммичены в ветку `search-improvement`

## Начало работы

1. Изучи текущую реализацию в `src/search.py`
2. Изучи исходные данные: `data/knowledge.html`, `data/sections.json`
3. Изучи `docs/conventions.md` и `docs/workflow.md`
4. Предложи решение на высоком уровне для итерации 6
5. Дождись подтверждения от пользователя
6. Начни выполнение
7. Отмечай прогресс чекбоксами в `docs/tasklist_v0.1.md`

## Вопросы

Если что-то непонятно:
1. Изучи `docs/vision.md` — там описаны все технические решения
2. Изучи `docs/conventions.md` — там описаны правила разработки
3. Изучи `docs/workflow.md` — там описан процесс работы
4. Следуй принципам KISS — выбирай самое простое решение

**Удачи!**
