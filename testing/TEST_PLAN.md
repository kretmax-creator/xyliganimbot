# План тестирования семантического поиска и ответов бота

## Цель тестирования

Проверить корректность работы семантического поиска и форматирования ответов бота в различных сценариях использования.

## Подготовка к тестированию

### Предварительные условия

1. ✅ Выполнена векторизация: `python test_vectorize.py`
2. ✅ Загружена модель: `python test_download_model.py`
3. ✅ Импортирован контент: `python test_import_content.py`
4. ✅ Настроен `.env` с `TELEGRAM_BOT_TOKEN`
5. ✅ Настроен `config.yaml` с белыми списками
6. ✅ Бот запущен: `python -m src.bot`

### Структура тестирования

Тестирование разделено на два блока:
- **Блок 1**: Тесткейсы для семантического поиска (проверка логики поиска)
- **Блок 2**: Тесткейсы для ответов бота (проверка форматирования и UX)

---

## Блок 1: Тесткейсы семантического поиска

### Категория 1.1: Базовые запросы (проверка релевантности)

#### TC-1.1.1: Точное совпадение с заголовком раздела
**Запрос**: Точная формулировка заголовка раздела из документа  
**Ожидаемый результат**:
- Найден раздел с score > 0.7
- Раздел находится на первом месте в результатах
- Score отображается корректно

**Примеры запросов**:
- "7.1 Outlook после смены пароля ВРМ"
- "6.2 Продление УЗ ГК Иннотех"
- "3.4 Настройка VPN ВТБ Region"

#### TC-1.1.2: Синонимичные запросы
**Запрос**: Запрос, синонимичный заголовку раздела  
**Ожидаемый результат**:
- Найден релевантный раздел с score > 0.5
- Раздел в топ-3 результатах

**Примеры запросов**:
- "Как настроить Outlook?" → раздел "7.1 Outlook после смены пароля ВРМ"
- "Проблемы с VPN" → раздел про VPN
- "Доступ к базе данных" → раздел "1. Контуры и области применения" (или где упоминается БД/доступ)

#### TC-1.1.3: Запросы по содержимому раздела
**Запрос**: Ключевые слова из текста раздела (не из заголовка)  
**Ожидаемый результат**:
- Найден раздел с score > 0.3
- Раздел содержит упомянутые ключевые слова

**Примеры запросов**:
- "сменить заводской PIN" (раздел 3.1)
- "автоматическая блокировка УЗ" (раздел 2.1)
- "VTB Certificate" (раздел 3.4)

### Категория 1.2: Сложные запросы (многословные, контекстные)

#### TC-1.2.1: Многословный запрос
**Запрос**: Развернутый вопрос с несколькими ключевыми словами  
**Ожидаемый результат**:
- Найдены релевантные разделы
- Score учитывает все ключевые слова

**Примеры запросов**:
- "Как настроить токен для первого подключения?"
- "Что делать если статус токена Blocked?"
- "Как продлить сертификат Иннотех?"

#### TC-1.2.2: Запрос с отрицанием
**Запрос**: Запрос с отрицанием или исключением  
**Ожидаемый результат**:
- Результаты не содержат исключенные термины (если применимо)
- Score корректно отражает релевантность

**Примеры запросов**:
- "настройка VPN, но не Иннотех"
- "антивирус без установки на ноутбук"

#### TC-1.2.3: Запрос на другом языке
**Запрос**: Запрос на английском языке (модель multilingual)  
**Ожидаемый результат**:
- Найдены релевантные разделы
- Score > 0.2

**Примеры запросов**:
- "How to configure VPN?"
- "Outlook problems"
- "Token setup"

### Категория 1.3: Граничные случаи

#### TC-1.3.1: Очень короткий запрос (1-2 слова)
**Запрос**: Одно или два слова  
**Ожидаемый результат**:
- Найдены релевантные разделы (если запрос информативен)
- Score может быть ниже из-за краткости

**Примеры запросов**:
- "VPN"
- "Outlook"
- "токен"

#### TC-1.3.2: Очень длинный запрос (>100 символов)
**Запрос**: Очень длинный запрос с множеством слов  
**Ожидаемый результат**:
- Найдены релевантные разделы
- Score учитывает все ключевые слова
- Результаты не ухудшаются из-за длины

**Пример запроса**:
- "Мне нужно настроить VPN подключение для доступа к внутренним ресурсам банка, но я не знаю какой сертификат выбрать и какой адрес сервера использовать"

#### TC-1.3.3: Запрос с опечатками
**Запрос**: Запрос с опечатками в ключевых словах  
**Ожидаемый результат**:
- Найдены релевантные разделы (семантический поиск должен быть устойчив к опечаткам)
- Score может быть немного ниже

**Примеры запросов**:
- "ВПН" (вместо "VPN")
- "Аутлук" (вместо "Outlook")
- "рутокен" (вместо "Rutoken")

#### TC-1.3.4: Запрос с специальными символами
**Запрос**: Запрос со знаками препинания, кавычками, скобками  
**Ожидаемый результат**:
- Запрос обработан корректно
- Специальные символы не вызывают ошибок

**Примеры запросов**:
- "Как настроить VPN?"
- "Проблемы (Траблы) с Outlook"
- "Настройка 'токена'"

### Категория 1.4: Проверка score и ранжирования

#### TC-1.4.1: Проверка ранжирования результатов
**Запрос**: Запрос, для которого ожидается несколько релевантных разделов  
**Ожидаемый результат**:
- Результаты отсортированы по убыванию score
- Первый результат имеет максимальный score
- Score каждого результата отображается

**Пример запроса**: "настройка VPN"

#### TC-1.4.2: Проверка порога min_score=0.2
**Запрос**: Запрос, который может вернуть результаты с низким score  
**Ожидаемый результат**:
- Результаты с score >= 0.2 включены
- Результаты с score < 0.2 исключены
- Если все результаты < 0.2, возвращается пустой список

**Пример запроса**: "абсолютно нерелевантный запрос xyz123"

#### TC-1.4.3: Проверка лимита limit=15
**Запрос**: Запрос, который может вернуть много результатов  
**Ожидаемый результат**:
- Возвращается не более 15 результатов
- Все возвращенные результаты релевантны

**Пример запроса**: "настройка"

### Категория 1.5: Обработка ошибок и пустых результатов

#### TC-1.5.1: Пустой запрос
**Запрос**: Пустая строка или только пробелы  
**Ожидаемый результат**:
- Корректная обработка без ошибок
- Сообщение пользователю о необходимости ввести запрос

#### TC-1.5.2: Запрос без результатов
**Запрос**: Запрос, не имеющий релевантных разделов  
**Ожидаемый результат**:
- Возвращается сообщение "По вашему запросу ничего не найдено"
- Предложение изменить формулировку запроса

**Пример запроса**: "как приготовить пиццу"

#### TC-1.5.3: Запрос только с символами
**Запрос**: Запрос, состоящий только из специальных символов  
**Ожидаемый результат**:
- Корректная обработка без ошибок
- Либо пустой результат, либо сообщение об ошибке

**Примеры запросов**:
- "!!!"
- "@@@"
- "---"

### Категория 1.6: Синонимы и сленг (Paraphrasing)
*Цель: Проверить понимание неформальной лексики*

#### TC-1.6.1 (P-01): Сленг для оборудования
**Запрос**: "Флешка заблочилась, что делать?"
**Ожидаемый результат**: Найден раздел "3.1 Первоначальная настройка токена (Rutoken)" или "1. Rutoken" с высоким score.
**Почему важно**: В тексте "USB-токен", пользователь пишет "флешка".

#### TC-1.6.2 (P-02): Описание проблемы вместо термина
**Запрос**: "Не работает видео в Дионе"
**Ожидаемый результат**: Найден раздел "8.1 Сетевые исключения (Dion)".
**Почему важно**: Пользователь описывает симптом.

#### TC-1.6.3 (P-03): Сленг для рабочего процесса
**Запрос**: "Как попасть на удаленку?"
**Ожидаемый результат**: Найден раздел "1.1 Контур Region" (ВРМ) или "1.2 Контур DevCorp".
**Почему важно**: "Удаленка" - синоним ВРМ/VDI/VPN.

#### TC-1.6.4 (P-04): Компьютерный сленг
**Запрос**: "Учетка заблочилась"
**Ожидаемый результат**: Найден раздел "1.2 Контур DevCorp" (Последствие нарушения: Блокировка) или "2.1 Обязательное ПО" (автоматическая блокировка УЗ).
**Почему важно**: "Учетка" -> "УЗ", "заблочилась" -> "Блокировка".

### Категория 1.7: Причинно-следственные связи (Causality)
*Цель: Проверить поиск причин и следствий*

#### TC-1.7.1 (C-01): Поиск причины по следствию
**Запрос**: "Почему меня заблокировали в девкорпе?"
**Ожидаемый результат**: Найден раздел "1.2 Контур DevCorp" (Последствие нарушения) или "2.1 Обязательное ПО" (Отсутствие NAC Сакура).
**Почему важно**: Поиск причины блокировки.

#### TC-1.7.2 (C-02): Поиск обоснования
**Запрос**: "Зачем нужна виртуалка?"
**Ожидаемый результат**: Найден раздел "1.2 Контур DevCorp" (Устройство: только виртуальная машина).
**Почему важно**: Понимание требований к устройству.

#### TC-1.7.3 (C-03): Поиск анти-паттернов
**Запрос**: "Что будет, если я поставлю DLP на свой ноутбук?"
**Ожидаемый результат**: Найден раздел "1.2 Контур DevCorp" (Ограничение: Подключение с корпоративного ноутбука запрещено) или "2.1 Обязательное ПО" (Установка... запрещена).
**Почему важно**: Проверка запрещенных действий.

#### TC-1.7.4 (C-04): Связь ошибки и причины
**Запрос**: "Сакура ругается на связь с сервером"
**Ожидаемый результат**: Найден раздел "2.1 Обязательное ПО" (NAC Сакура) или Troubleshooting.
**Почему важно**: Связь ошибки приложения с компонентом.

### Категория 1.8: Точный поиск сущностей (NER)
*Цель: Проверить точность фактов*

#### TC-1.8.1 (F-01): Поиск адресов
**Запрос**: "Какой адрес у шлюза для разработки?"
**Ожидаемый результат**: Найден раздел "1.2 Контур DevCorp" (адрес `ext.vpn.vtb.ru`) или "3.5 Настройка VPN ВТБ ext".
**Почему важно**: Не перепутать с `cvpn.vtb.ru`.

#### TC-1.8.2 (F-02): Поиск телефонов
**Запрос**: "Номер телефона поддержки Иннотеха"
**Ожидаемый результат**: Найден раздел "9. Поддержка" (`8 800...`).
**Почему важно**: Точное извлечение цифр.

#### TC-1.8.3 (F-03): Поиск специфических значений
**Запрос**: "Какой заводской пароль на токене?"
**Ожидаемый результат**: Найден раздел "3.1 Первоначальная настройка токена" (`1234567890`).
**Почему важно**: Поиск конкретного значения.

#### TC-1.8.4 (F-04): Различение контекста поддержки
**Запрос**: "Кому писать по проблемам с DLP?"
**Ожидаемый результат**: Найден раздел "3.3 Установка обязательного ПО" или "9. Поддержка" (email PhoenixIT).
**Почему важно**: Различение внешней и внутренней поддержки.

### Категория 1.9: Процедурные знания и неоднозначность
*Цель: Проверить инструкции и устранение неоднозначности*

#### TC-1.9.1 (H-01): Поиск инструкций
**Запрос**: "Как настроить аутлук?"
**Ожидаемый результат**: Найден раздел "7.1 Outlook после смены пароля ВРМ".
**Почему важно**: Инструкция может быть внутри Troubleshooting.

#### TC-1.9.2 (H-02): Изменение процесса
**Запрос**: "Продление учетки Иннотех"
**Ожидаемый результат**: Найден раздел "6.2 Продление УЗ ГК Иннотех" (про автоматическое продление).
**Почему важно**: Модель должна найти информацию, что делать ничего не надо.

#### TC-1.9.3 (N-01): Неоднозначный запрос
**Запрос**: "Настройки VPN"
**Ожидаемый результат**: Найдены разделы 3.4, 3.5, 4.1, 4.2.
**Почему важно**: Запрос широкий, должны быть найдены разные варианты VPN.

#### TC-1.9.4 (N-03): Проверка запретов
**Запрос**: "Можно отправить письмо на яндекс почту?"
**Ожидаемый результат**: Найден раздел с ограничениями (если есть в тексте, например "2.1 Обязательное ПО" или общие ограничения). В текущем knowledge.md явного запрета на яндекс почту нет, но есть ограничения по DLP.
**Примечание**: Если в тексте нет явного запрета, этот тест может не сработать. Проверить раздел ограничений.


---

## Блок 2: Тесткейсы ответов бота

### Категория 2.1: Форматирование результатов

#### TC-2.1.1: Проверка HTML-форматирования
**Проверка**: Форматирование заголовков и текста  
**Ожидаемый результат**:
- Заголовки разделов отображаются жирным (`<b>`)
- Score отображается в формате "релевантность: XX.X%"
- Текст раздела отображается корректно
- HTML-символы экранированы (`&`, `<`, `>`)

**Проверка**: Отправить запрос и проверить форматирование в Telegram

#### TC-2.1.2: Проверка snippet для больших разделов
**Проверка**: Раздел с текстом > 500 символов  
**Ожидаемый результат**:
- Показывается snippet длиной ~300 символов
- Snippet обрезается по границе слова
- В конце snippet добавлено "..."

**Проверка**: Найти раздел с большим текстом и проверить форматирование

#### TC-2.1.3: Проверка полного текста для маленьких разделов
**Проверка**: Раздел с текстом < 500 символов  
**Ожидаемый результат**:
- Показывается полный текст раздела
- Нет обрезки и "..."

**Проверка**: Найти раздел с маленьким текстом и проверить форматирование

#### TC-2.1.4: Проверка удаления лишних пустых строк
**Проверка**: Раздел с множественными пустыми строками  
**Ожидаемый результат**:
- Лишние пустые строки удалены
- Текст отформатирован компактно
- Нет множественных переносов строк подряд

**Проверка**: Найти раздел с множественными пустыми строками и проверить форматирование

### Категория 2.2: Отображение score и предупреждений

#### TC-2.2.1: Проверка отображения score
**Проверка**: Score отображается для каждого результата  
**Ожидаемый результат**:
- Score отображается в формате "релевантность: XX.X%"
- Процент вычисляется корректно (score * 100)
- Score отображается для всех результатов

#### TC-2.2.2: Проверка предупреждения о низкой уверенности
**Проверка**: Результаты с score < 0.3  
**Ожидаемый результат**:
- Для результатов с score < 0.3 добавлено предупреждение "⚠️ (низкая уверенность)"
- Предупреждение отображается рядом с score

**Проверка**: Найти запрос, который возвращает результаты с низким score

#### TC-2.2.3: Проверка отсутствия предупреждения для высокого score
**Проверка**: Результаты с score >= 0.3  
**Ожидаемый результат**:
- Предупреждение о низкой уверенности отсутствует
- Отображается только score

### Категория 2.3: Разбиение длинных сообщений

#### TC-2.3.1: Проверка разбиения сообщения > 4096 символов
**Проверка**: Запрос, возвращающий много результатов с длинным текстом  
**Ожидаемый результат**:
- Сообщение разбито на несколько частей
- Каждая часть < 4096 символов
- Первая часть отправлена как reply
- Последующие части отправлены как обычные сообщения
- Разделитель "─" * 30 используется корректно

**Проверка**: Отправить запрос, который вернет много результатов с длинным текстом

#### TC-2.3.2: Проверка сохранения форматирования при разбиении
**Проверка**: Форматирование HTML сохраняется при разбиении  
**Ожидаемый результат**:
- HTML-теги не разрываются между частями
- Форматирование сохраняется в каждой части

### Категория 2.4: Обработка ошибок в ответах

#### TC-2.4.1: Обработка отсутствия документа
**Проверка**: Удалить `data/knowledge.md` и отправить запрос  
**Ожидаемый результат**:
- Сообщение: "Документ базы знаний не найден. Обратитесь к администратору для загрузки контента."
- Ошибка логируется

#### TC-2.4.2: Обработка отсутствия модели
**Проверка**: Удалить модель из `models/` и отправить запрос  
**Ожидаемый результат**:
- Сообщение: "Модель для семантического поиска не найдена. Обратитесь к администратору для загрузки модели."
- Ошибка логируется

#### TC-2.4.3: Обработка отсутствия embeddings
**Проверка**: Удалить embeddings из кэша и отправить запрос  
**Ожидаемый результат**:
- Сообщение: "Поисковая система не инициализирована. Обратитесь к администратору."
- Ошибка логируется

#### TC-2.4.4: Обработка ошибки при поиске
**Проверка**: Поврежденный кэш или некорректные данные  
**Ожидаемый результат**:
- Сообщение: "Произошла ошибка при поиске. Попробуйте позже."
- Ошибка логируется с полным traceback

### Категория 2.5: Логирование

#### TC-2.5.1: Проверка логирования запросов
**Проверка**: Отправить запрос и проверить `logs/app.log`  
**Ожидаемый результат**:
- Запрос логируется с user_id, username, query
- Формат: `Search query from user_id=X, username=Y, query='...'`

#### TC-2.5.2: Проверка логирования результатов
**Проверка**: Отправить запрос и проверить логи  
**Ожидаемый результат**:
- Результаты логируются с количеством и score
- Формат: `Search completed: N results found (scores: [...])`

#### TC-2.5.3: Проверка логирования ошибок
**Проверка**: Вызвать ошибку и проверить логи  
**Ожидаемый результат**:
- Ошибки логируются с уровнем ERROR
- Включен полный traceback (exc_info=True)

### Категория 2.6: Команды бота

#### TC-2.6.1: Проверка команды /help
**Проверка**: Отправить `/help`  
**Ожидаемый результат**:
- Отображается справка по использованию бота
- Команда обрабатывается корректно

#### TC-2.6.2: Проверка обработки команд как текста
**Проверка**: Отправить текст, начинающийся с "/" но не являющийся командой  
**Ожидаемый результат**:
- Текст обрабатывается как поисковый запрос
- Не возникает ошибок

---

## Чеклист для тестирования

### Подготовка
- [ ] Векторизация выполнена (`python test_vectorize.py`)
- [ ] Модель загружена (`python test_download_model.py`)
- [ ] Контент импортирован (`python test_import_content.py`)
- [ ] Бот запущен (`python -m src.bot`)
- [ ] Telegram-клиент готов к тестированию

### Блок 1: Семантический поиск
- [ ] TC-1.1.1: Точное совпадение с заголовком
- [ ] TC-1.1.2: Синонимичные запросы
- [ ] TC-1.1.3: Запросы по содержимому
- [ ] TC-1.2.1: Многословный запрос
- [ ] TC-1.2.2: Запрос с отрицанием
- [ ] TC-1.2.3: Запрос на другом языке
- [ ] TC-1.3.1: Очень короткий запрос
- [ ] TC-1.3.2: Очень длинный запрос
- [ ] TC-1.3.3: Запрос с опечатками
- [ ] TC-1.3.4: Запрос с специальными символами
- [ ] TC-1.4.1: Проверка ранжирования
- [ ] TC-1.4.2: Проверка порога min_score
- [ ] TC-1.4.3: Проверка лимита limit
- [ ] TC-1.5.1: Пустой запрос
- [ ] TC-1.5.2: Запрос без результатов
- [ ] TC-1.5.3: Запрос только с символами
- [ ] TC-1.6.1 (P-01): Сленг (Флешка)
- [ ] TC-1.6.2 (P-02): Описание проблемы (Дион)
- [ ] TC-1.6.3 (P-03): Сленг (Удаленка)
- [ ] TC-1.6.4 (P-04): Сленг (Комп висит)
- [ ] TC-1.7.1 (C-01): Причина по следствию (Блокировка)
- [ ] TC-1.7.2 (C-02): Обоснование (Виртуалка)
- [ ] TC-1.7.3 (C-03): Анти-паттерн (DLP на ноут)
- [ ] TC-1.7.4 (C-04): Ошибка и причина (Сакура)
- [ ] TC-1.8.1 (F-01): Адрес шлюза
- [ ] TC-1.8.2 (F-02): Телефон поддержки
- [ ] TC-1.8.3 (F-03): Пароль на токене
- [ ] TC-1.8.4 (F-04): Email поддержки DLP
- [ ] TC-1.9.1 (H-01): Настройка Outlook
- [ ] TC-1.9.2 (H-02): Продление учетки
- [ ] TC-1.9.3 (N-01): Неоднозначный VPN
- [ ] TC-1.9.4 (N-03): Запрет на почту

### Блок 2: Ответы бота
- [ ] TC-2.1.1: HTML-форматирование
- [ ] TC-2.1.2: Snippet для больших разделов
- [ ] TC-2.1.3: Полный текст для маленьких разделов
- [ ] TC-2.1.4: Удаление лишних пустых строк
- [ ] TC-2.2.1: Отображение score
- [ ] TC-2.2.2: Предупреждение о низкой уверенности
- [ ] TC-2.2.3: Отсутствие предупреждения для высокого score
- [ ] TC-2.3.1: Разбиение длинных сообщений
- [ ] TC-2.3.2: Сохранение форматирования при разбиении
- [ ] TC-2.4.1: Обработка отсутствия документа
- [ ] TC-2.4.2: Обработка отсутствия модели
- [ ] TC-2.4.3: Обработка отсутствия embeddings
- [ ] TC-2.4.4: Обработка ошибки при поиске
- [ ] TC-2.5.1: Логирование запросов
- [ ] TC-2.5.2: Логирование результатов
- [ ] TC-2.5.3: Логирование ошибок
- [ ] TC-2.6.1: Команда /help
- [ ] TC-2.6.2: Обработка команд как текста

---

## Формат отчета о тестировании

Для каждого тесткейса фиксировать:

1. **Номер тесткейса**: TC-X.X.X
2. **Статус**: ✅ PASS / ❌ FAIL / ⚠️ WARNING
3. **Запрос**: Точный текст запроса
4. **Результаты**: Количество найденных разделов, score топ-3 результатов
5. **Наблюдения**: Что работает корректно, что требует доработки
6. **Скриншоты**: Скриншоты ответов бота (для визуальной проверки)

### Пример записи:

```
TC-1.1.1: Точное совпадение с заголовком
Статус: ✅ PASS
Запрос: "Проблемы (Траблы) Outlook"
Результаты:
  - Найдено разделов: 1
  - Score: 0.856
  - Раздел найден на первом месте
Наблюдения: Работает корректно, score высокий как ожидалось
```

---

## Приоритеты тестирования

### Высокий приоритет (критичные функции)
1. TC-1.1.1, TC-1.1.2: Базовые запросы
2. TC-1.4.1: Ранжирование результатов
3. TC-2.1.1: HTML-форматирование
4. TC-2.2.1: Отображение score
5. TC-2.4.1-2.4.4: Обработка ошибок

### Средний приоритет (важные функции)
1. TC-1.2.1, TC-1.2.2: Сложные запросы
2. TC-1.3.1-1.3.4: Граничные случаи
3. TC-2.1.2-2.1.4: Форматирование текста
4. TC-2.3.1-2.3.2: Разбиение сообщений

### Низкий приоритет (дополнительные проверки)
1. TC-1.2.3: Запросы на другом языке
2. TC-2.5.1-2.5.3: Логирование
3. TC-2.6.1-2.6.2: Команды бота