# Варианты решений для прохождения проваленных тестов (COMPREHENSIVE_TEST_SUITE)

**Контекст:** 7 из 40 тесткейсов не проходили. Ниже — варианты решений по группам причин.

**Реализовано (26.01.2026):** применены выбранные варианты; для п.1 использована детекция «вне домена» (чёрный список) вместо только поднятия порогов. Все 40 тестов проходят.

---

## 1. Нерелевантные запросы (TC-2.2.1, TC-2.2.2, TC-2.2.4)

**Суть:** Для запросов вне контекста базы («как приготовить пиццу», «xyz123», «письмо на яндекс почту») E5 даёт score 0.78–0.93, текущие пороги (0.7, 0.6) не отсекают.

### Вариант А: Поднять пороги (минимальный код)

В `search()` в `src/search.py`:

- `filter_out_of_context_results(results, min_max_score=0.85)` вместо 0.7;
- `filter_low_confidence_results(results, min_first_score=0.78)` вместо 0.6.

**Риск:** часть слабо релевантных, но уместных ответов может исчезнуть (ложные пустые ответы). Имеет смысл проверить по кейсам 1.1–1.5 после изменения.

### Вариант Б: Детекция «вне домена» по ключевым словам

Перед семантическим поиском вызывать `is_out_of_domain(query)` и при `True` сразу возвращать `[]`.

Черный список подстрок/токенов (или регулярок):

- «пицц», «приготовить пиццу»;
- «xyz123», «нерелевантный запрос»;
- «яндекс почту», «яндекс почт», «отправить письмо на яндекс».

Реализация: словарь/список фраз + проверка `any(phrase in query_lower for phrase in OUT_OF_DOMAIN_PHRASES)`.

**Плюс:** не трогаем пороги, режем только заведомо посторонние запросы.  
**Минус:** список надо поддерживать; возможны пропуски при новых формулировках.

### Вариант В: Комбинация А + Б

Пороги чуть поднять (например, 0.78 / 0.75) и добавить короткий черный список для явных «мусорных» формулировок из теста. Так снижается риск отсечь пограничные, но релевантные ответы.

**Рекомендация:** начать с Варианта Б для точных формулировок из TC-2.2.x; если по другим тестам появятся лишние пустые ответы — добавить Вариант А с осторожным подбором порогов.

---

## 2. Адрес шлюза для разработки (TC-1.5.1)

**Запрос:** «Какой адрес у шлюза для разработки?»  
**Проблема:** в топе «3. Onboarding» (score 0.99), а нужен раздел с `ext.vpn.vtb.ru` (в базе он есть в разделах 1.2 Контур DevCorp, 3.4/3.5 VPN).

### Вариант А: Дополнительный буст по «адрес/шлюз/разработка» + URL

В `boost_exact_matches` или новой функции `boost_url_and_gateway()`:

- если в запросе есть токены «адрес», «шлюз», «разработ» (или «разработк»),
- то разделам, в тексте которых есть «ext.vpn», «vtb.ru» или «шлюз», добавлять к score фиксированный буст (например, +0.15).

Токены запроса уже есть в `boost_exact_matches`; можно расширить логику там или вызвать после неё отдельный шаг только для таких запросов.

### Вариант Б: Синонимы в запросе

В `QUERY_REPLACEMENTS` в `src/search.py` добавить, например:

- «шлюз» → оставить как есть, но добавить в запрос для поиска подсказку «ext.vpn vpn devcorp» при наличии «шлюз» + «разработ».

Либо расширить `preprocess_query`/отдельный шаг: при наличии («шлюз» и «разработ») добавлять к нормализованному запросу слова «ext.vpn devcorp vpn».

**Рекомендация:** Вариант А проще контролировать и не раздувает запрос; Вариант Б можно использовать как дополнение, если буста окажется недостаточно.

---

## 3. Сертификаты — раздел 3.4 (TC-5.3)

**Запрос:** «нужно все сертификаты автоматически обновить».  
**Проблема:** первый результат — «6.2 Продление УЗ» (0.88), ожидается раздел 3.4 или явно про сертификаты.

### Вариант А: Усиленный буст по «сертификат»

В `boost_exact_matches` для токена «сертификат» (и, при желании, «обнов») использовать больший вес, например `text_weight=0.12` или отдельный множитель только для этого токена. Цель — поднять разделы с «сертификат» и «3.4»/«vpn» выше «6.2 Продление УЗ».

### Вариант Б: Отдельная логика для «сертификат + обнов»

Если в запросе есть и «сертификат», и «обнов» (или «автоматическ»), давать разделам, где в тексте есть и «сертификат», и («3.4» или «vpn»), дополнительный буст (например, +0.1 к score).

**Рекомендация:** начать с Варианта А (увеличенный вес для «сертификат» в тексте/заголовке); при необходимости добавить Вариант Б.

---

## 4. Джира / Jira (TC-5.5)

**Запрос:** «не могу в джире авторизоваться».  
**Проблема:** в топе «3.1 Токен»; ожидаются разделы про Jira/Confluence/VPN/доступ. В самой базе знаний слов «jira»/«confluence» нет, но в пользовательских формулировках (knowledge_base_queries) доступ к Jira/Confluence связывается с VPN (в т.ч. DevCorp/ext.vpn).

### Вариант А: Синонимы + буст по VPN/доступ

1. В `QUERY_REPLACEMENTS` добавить: `"джира": "jira"`, `"джире": "jira"` (и по необходимости «джиру» и т.п.).
2. Специальный буст: если в нормализованном запросе есть «jira» (или «confluence»), разделам, в заголовке/тексте которых есть и «vpn», и («ext.vpn» или «devcorp» или «доступ»), добавлять к score фиксированный буст (например, +0.12).

Так разделы про VPN DevCorp/доступ поднимутся выше «3.1 Токен» при запросах про «джиру».

### Вариант Б: Расширение базы знаний

В разделы про DevCorp/VPN (например, 1.2 Контур DevCorp, 3.4/3.5 VPN) добавить явную фразу вроде: «Через данный VPN обеспечивается доступ к Jira, Confluence и другим ресурсам разработки». Тогда обычный семантический поиск по «jira» уже начнёт находить эти разделы.

**Рекомендация:** Вариант Б даёт долгосрочно лучшее качество и не усложняет поиск. Вариант А можно сделать быстрее в коде без правки контента; при необходимости сочетать оба.

---

## 5. Антивирус без установки (TC-1.4.2)

**Запрос:** «антивирус без установки на ноутбук».  
**Проблема:** в топе «7. Troubleshooting» (0.81), ожидается раздел про правила установки ПО.

### Вариант А: Ослабить ожидание в тесте (Low)

Изменить проверку в `test_comprehensive_suite.py` для TC-1.4.2: считать успехом, если в топ-5 есть раздел, содержащий хотя бы одно из слов «установк», «правил», «обязательн», «по» (в смысле «правила по установке») или «3.3» (если в базе установка ПО описана там). Либо допустить «7. Troubleshooting» как допустимый ответ для этого запроса.

**Рекомендация:** по приоритету тест Low; быстрее всего — скорректировать критерий (Вариант А), не трогая ранжирование.

### Вариант Б: Контент и буст

Проверить, есть ли в базе отдельный раздел про «правила установки ПО». Если есть — добавить буст для запросов, содержащих «установк» и «без»/«правил», к разделам с «установк» и «правил». Если такого раздела нет — либо добавить короткий подраздел/абзац, либо оставить ослабленный критерий (Вариант А).

---

## 6. Порядок внедрения

1. **Сначала** — варианты по п. 1 (нерелевантные запросы), лучше Б или В, чтобы TC-2.2.1, TC-2.2.2, TC-2.2.4 стали зелёными без сильного влияния на остальные.
2. **Затем** — п. 2 (адрес шлюза) и п. 4 (джира): буст и/или синонимы в `src/search.py`.
3. **Потом** — п. 3 (сертификаты): буст по «сертификат».
4. **В конце** — п. 5 (антивирус): либо смягчение теста (А), либо контент+буст (Б).

После каждого блока — прогон `python test_comprehensive_suite.py` и просмотр отчёта, чтобы не ухудшить уже проходящие тесты.

---

## 7. Затрагиваемые файлы

| Изменение | Файл |
|-----------|------|
| Пороги, детекция вне домена, бусты, синонимы | `src/search.py` |
| Критерии для TC-1.4.2, при необходимости — для TC-2.2.x | `test_comprehensive_suite.py` |
| Текст про Jira/Confluence в разделах VPN/DevCorp | `data/knowledge.md` (при выборе Варианта Б в п. 4) |

Если нужно, можно перейти к пошаговой реализации выбранных вариантов (сначала п. 1, затем 2–5) с отдельными правками и проверкой после каждого шага.
